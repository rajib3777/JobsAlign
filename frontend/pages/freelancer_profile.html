{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Freelancer Profile • JobsAlign</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/lucide-static@latest/font/lucide.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --indigo: #4f46e5;
      --emerald: #10b981;
      --rose: #ef4444;
      --amber: #f59e0b;
      --cyan: #06b6d4;
      --violet: #7c3aed;
      --gray-bg: #f8fafc;
    }
    body {
      background: linear-gradient(145deg, #eef2ff 0%, #fdfdfd 60%, #f0fdf4 100%);
      font-family: "Inter", system-ui, sans-serif;
    }
    .card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
      transition: all 0.3s ease;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
    }
    .gradient-btn {
      background: linear-gradient(90deg, var(--indigo), var(--emerald));
      color: white;
    }
    .gradient-btn:hover {
      background: linear-gradient(90deg, var(--violet), var(--cyan));
    }
  </style>
</head>

<body class="min-h-screen flex flex-col">
  <!-- NAV -->
  <nav class="bg-white/80 backdrop-blur border-b border-gray-200 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-6 py-3 flex items-center justify-between">
      <a href="/freelancer/dashboard/" class="flex items-center gap-3">
        <img src="{% static 'images/logo.jpeg' %}" class="w-28" alt="JobsAlign">
        <h1 class="font-bold text-lg text-indigo-600">Freelancer Profile</h1>
      </a>
      <a href="/login/" class="text-sm text-rose-500 hover:text-rose-700 flex items-center gap-1">
        <i class="lucide-log-out"></i> Logout
      </a>
    </div>
  </nav>

  <!-- CONTENT -->
  <main class="flex-1 max-w-7xl mx-auto px-6 py-10 space-y-8">

    <!-- HEADER -->
    <section class="card p-6 flex flex-col lg:flex-row items-center lg:items-start gap-6">
      <div class="relative">
        <img id="avatarImg" src="{% static 'images/avatar.png' %}" class="w-32 h-32 rounded-full border-4 border-indigo-500 shadow-md object-cover" />
        <label for="avatarUpload" class="absolute bottom-0 right-0 bg-indigo-600 p-2 rounded-full cursor-pointer hover:bg-indigo-700">
          <i class="lucide-camera text-white"></i>
        </label>
        <input id="avatarUpload" type="file" accept="image/*" class="hidden" />
      </div>
      <div class="flex-1 text-center lg:text-left">
        <h2 id="freelancerName" class="text-2xl font-bold text-gray-900">Loading...</h2>
        <p id="freelancerBio" class="text-gray-600 mt-2 text-sm">—</p>
        <div class="mt-3 flex flex-wrap justify-center lg:justify-start gap-2">
          <span id="freelancerLevel" class="px-3 py-1 bg-indigo-50 text-indigo-700 rounded-full text-sm"></span>
          <span id="verificationBadge" class="px-3 py-1 bg-amber-50 text-amber-700 rounded-full text-sm"></span>
          <span id="subscriptionPlan" class="px-3 py-1 bg-emerald-50 text-emerald-700 rounded-full text-sm"></span>
        </div>
      </div>
      <button id="saveProfileBtn" class="gradient-btn px-5 py-2.5 rounded-lg font-semibold shadow">Save Profile</button>
    </section>

    <!-- BASIC INFO -->
    <section class="grid md:grid-cols-2 gap-6">
      <div class="card p-6">
        <h3 class="font-semibold text-lg mb-4 text-indigo-700">Personal Info</h3>
        <div class="space-y-3">
          <div>
            <label class="text-sm font-medium text-gray-700">Full Name</label>
            <input id="fullName" type="text" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Enter full name">
          </div>
          <div>
            <label class="text-sm font-medium text-gray-700">Email (readonly)</label>
            <input id="email" type="text" class="w-full border border-gray-200 bg-gray-100 rounded-md px-3 py-2" readonly>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-700">Location</label>
            <input id="location" type="text" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Your location">
          </div>
        </div>
      </div>

      <div class="card p-6">
        <h3 class="font-semibold text-lg mb-4 text-emerald-700">Professional Info</h3>
        <div class="space-y-3">
          <div>
            <label class="text-sm font-medium text-gray-700">Hourly Rate ($)</label>
            <input id="hourlyRate" type="number" min="0" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="e.g. 25">
          </div>
          <div>
            <label class="text-sm font-medium text-gray-700">Skills (comma-separated)</label>
            <textarea id="skills" class="w-full border border-gray-300 rounded-md px-3 py-2" rows="2"></textarea>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-700">Bio</label>
            <textarea id="bio" class="w-full border border-gray-300 rounded-md px-3 py-2" rows="3"></textarea>
          </div>
        </div>
      </div>
    </section>

    <!-- STATS -->
    <section class="grid lg:grid-cols-3 gap-6">
      <div class="card p-6">
        <h3 class="text-lg font-semibold mb-3 text-violet-700">Performance</h3>
        <p id="ratingScore" class="text-4xl font-bold text-gray-900">—</p>
        <p class="text-sm text-gray-500">Average Rating</p>
      </div>
      <div class="card p-6">
        <h3 class="text-lg font-semibold mb-3 text-cyan-700">Projects Completed</h3>
        <p id="projectsCount" class="text-4xl font-bold text-gray-900">—</p>
        <p class="text-sm text-gray-500">Total successful projects</p>
      </div>
      <div class="card p-6">
        <h3 class="text-lg font-semibold mb-3 text-amber-700">Earnings</h3>
        <p id="totalEarnings" class="text-4xl font-bold text-gray-900">—</p>
        <p class="text-sm text-gray-500">Lifetime earnings</p>
      </div>
    </section>

    <!-- CHARTS -->
    <section class="card p-6">
      <h3 class="text-lg font-semibold mb-3 text-indigo-700">Monthly Performance</h3>
      <canvas id="profileChart" height="100"></canvas>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="bg-gradient-to-b from-gray-50 to-white text-gray-800 border-t border-gray-200 mt-20 py-8 text-center text-sm">
    © 2025 <b class="text-indigo-600">JobsAlign</b>. Empowering freelancers worldwide.
  </footer>

  <!-- JS -->
  <script>
    const API = "http://127.0.0.1:8000/api";
    const token = localStorage.getItem("access_token");
    if(!token) window.location.href="/login/";

    const $ = (id)=>document.getElementById(id);
    const money=(n)=>"$"+(parseFloat(n||0)).toFixed(2);

    async function apiGet(path){
      const res = await fetch(API+path, { headers:{Authorization:"Bearer "+token}});
      return await res.json();
    }
    async function apiPost(path,body){
      const res = await fetch(API+path, {
        method:"POST",
        headers:{"Content-Type":"application/json", Authorization:"Bearer "+token},
        body:JSON.stringify(body)
      });
      return await res.json();
    }

    async function loadProfile(){
      const me = await apiGet("/accounts/me/");
      $("freelancerName").textContent = me.full_name || me.username;
      $("fullName").value = me.full_name || "";
      $("email").value = me.email || "";
      $("bio").value = me.bio || "";
      $("freelancerBio").textContent = me.bio || "No bio added.";
      $("skills").value = me.skills?.join(", ") || "";
      $("location").value = me.location || "";
      $("hourlyRate").value = me.hourly_rate || "";
      if(me.avatar_url) $("avatarImg").src = me.avatar_url;

      // Badge info
      const level = await apiGet("/levels/current/");
      $("freelancerLevel").textContent = level?.name ? `Level ${level.name}` : "Level —";

      const verify = await apiGet("/verification/status/");
      $("verificationBadge").textContent = verify?.verified ? "✅ Verified" : "⏳ Not Verified";

      const sub = await apiGet("/subscriptions/current/");
      $("subscriptionPlan").textContent = sub?.plan_name ? sub.plan_name : "Free Plan";

      const stats = await apiGet("/analytics/freelancer/summary/");
      $("ratingScore").textContent = stats?.rating_avg?.toFixed(1) || "—";
      $("projectsCount").textContent = stats?.projects_completed || 0;
      $("totalEarnings").textContent = money(stats?.total_earnings || 0);

      drawChart(stats?.months || [], stats?.earnings || []);
    }

    async function updateProfile(){
      const payload = {
        full_name: $("fullName").value,
        bio: $("bio").value,
        location: $("location").value,
        hourly_rate: $("hourlyRate").value,
        skills: $("skills").value.split(",").map(s=>s.trim())
      };
      const res = await apiPost("/accounts/update/", payload);
      localStorage.setItem("profile_updated", "1");
      alert("✅ Profile updated successfully!");
    }

    async function uploadAvatar(file){
      const form = new FormData();
      form.append("avatar", file);
      await fetch(API+"/accounts/upload-avatar/", {
        method:"POST", headers:{Authorization:"Bearer "+token}, body:form
      });
      localStorage.setItem("profile_updated", "1");
      loadProfile();
    }

    function drawChart(labels, data){
      const ctx = $("profileChart");
      new Chart(ctx,{
        type:"bar",
        data:{labels,datasets:[{label:"Earnings ($)",data,backgroundColor:["#4f46e5","#10b981","#f59e0b","#06b6d4","#ef4444","#7c3aed"],borderRadius:8}]},
        options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
      });
    }

    $("saveProfileBtn").onclick=updateProfile;
    $("avatarUpload").onchange=(e)=>uploadAvatar(e.target.files[0]);

    loadProfile();
  </script>
</body>
</html>
