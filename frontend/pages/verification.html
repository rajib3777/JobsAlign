{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Identity Verification • JobsAlign</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons -->
  <link href="https://unpkg.com/lucide-static@latest/font/lucide.css" rel="stylesheet">

  <style>
    :root{
      --ink:#0F172A; --muted:#475569; --brand:#4F46E5; --ok:#10B981; --warn:#F59E0B; --danger:#EF4444;
      --bg:#F8FAFC; --card:#FFFFFF; --line:#E5E7EB;
      --grad1: radial-gradient(900px 500px at 10% -10%, rgba(79,70,229,.10), transparent 60%);
      --grad2: radial-gradient(800px 400px at 90% 0%, rgba(16,185,129,.10), transparent 60%);
    }
    html,body{height:100%}
    body{
      background: var(--grad1), var(--grad2), var(--bg);
      color:var(--ink);
      font-family: ui-sans-serif,system-ui,Inter,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .card{background:var(--card); border:1px solid var(--line); border-radius:1rem; box-shadow:0 10px 30px rgba(2,6,23,.06)}
    .hover-rise{transition:transform .25s ease, box-shadow .25s ease}
    .hover-rise:hover{transform:translateY(-3px); box-shadow:0 16px 40px rgba(2,6,23,.10)}
    .badge{font-size:.75rem; padding:.25rem .55rem; border-radius:.5rem; white-space:nowrap}
    .badge-green{background:#DCFCE7;color:#166534}
    .badge-amber{background:#FEF3C7;color:#92400E}
    .badge-blue{background:#DBEAFE;color:#1E40AF}
    .badge-gray{background:#F1F5F9;color:#0F172A}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.65rem .95rem;border-radius:.8rem;font-weight:700;transition:all .2s ease}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-primary:hover{background:#4338CA}
    .btn-soft{background:#EEF2FF;color:#3730A3}
    .btn-soft:hover{background:#E0E7FF}
    .btn-ghost{background:#FFFFFF; border:1px dashed var(--line); color:var(--muted)}
    .btn-ghost:hover{border-color:#CBD5E1; color:#0F172A}
    .dot{width:.5rem;height:.5rem;border-radius:9999px;display:inline-block}
    .skeleton{background:linear-gradient(90deg,#f3f4f6 25%,#e5e7eb 37%,#f3f4f6 63%);background-size:400% 100%;animation:shimmer 1.4s ease infinite;border-radius:.5rem}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:-100% 0}}
    /* Mobile-first grid hygiene: prevent horizontal scroll */
    .safe-container{max-width:88rem;margin-inline:auto;padding:1rem}
    @media (min-width:640px){.safe-container{padding:1.25rem}}
    @media (min-width:1024px){.safe-container{padding:2rem}}
    /* File input shadowless */
    input[type="file"]::-webkit-file-upload-button{font-weight:600;border:0;background:#EEF2FF;color:#3730A3;border-radius:.5rem;padding:.45rem .7rem;margin-right:.6rem}
    input[type="file"]::file-selector-button{font-weight:600;border:0;background:#EEF2FF;color:#3730A3;border-radius:.5rem;padding:.45rem .7rem;margin-right:.6rem}
    /* Tooltip */
    .tip { position: relative; }
    .tip:hover .tip-bubble { opacity:1; transform:translateY(0) }
    .tip-bubble{ position:absolute; left:50%; bottom:calc(100% + .5rem); transform:translate(-50%,6px); opacity:0; transition:.2s ease; background:#0F172A; color:white; font-size:.75rem; padding:.35rem .5rem; border-radius:.35rem; white-space:nowrap }
  </style>
</head>

<body class="min-h-screen flex flex-col">
  <!-- NAV -->
  <nav class="bg-white/80 backdrop-blur sticky top-0 border-b border-gray-200 z-50">
    <div class="safe-container flex items-center justify-between">
      <a href="/freelancer/dashboard/" class="flex items-center gap-3 min-w-0">
        <img src="{% static 'images/logo.jpeg' %}" alt="JobsAlign Logo" class="w-28 sm:w-32 h-auto object-contain">
        <span class="hidden sm:inline-block px-2 py-0.5 rounded bg-indigo-50 text-indigo-700 text-xs font-semibold">
          Verification
        </span>
      </a>
      <div class="flex items-center gap-2 sm:gap-3">
        <a href="/freelancer/profile/" class="btn btn-soft"><i class="lucide-user-cog"></i><span class="hidden xs:inline">Profile</span></a>
        <a href="/freelancer/support/" class="btn btn-ghost"><i class="lucide-life-buoy"></i><span class="hidden xs:inline">Support</span></a>
        <a href="/login/" class="btn btn-ghost text-rose-600 border-rose-200"><i class="lucide-log-out"></i><span class="hidden xs:inline">Logout</span></a>
      </div>
    </div>
  </nav>

  <!-- LAYOUT -->
  <main class="safe-container w-full grow">
    <div class="grid grid-cols-1 lg:grid-cols-[300px_1fr] gap-6 lg:gap-8">
      <!-- SIDEBAR -->
      <aside class="card p-4 lg:p-5 h-max">
        <nav class="grid text-sm">
          <a href="/freelancer/dashboard/" class="px-3 py-2 rounded-lg hover:bg-gray-50 flex items-center gap-2"><i class="lucide-layout-dashboard"></i> Dashboard</a>
          <a href="/freelancer/profile/" class="px-3 py-2 rounded-lg hover:bg-gray-50 flex items-center gap-2"><i class="lucide-user"></i> Profile</a>
          <a href="/freelancer/jobs/" class="px-3 py-2 rounded-lg hover:bg-gray-50 flex items-center gap-2"><i class="lucide-briefcase"></i> Jobs</a>
          <a href="/freelancer/chat/" class="px-3 py-2 rounded-lg hover:bg-gray-50 flex items-center gap-2"><i class="lucide-message-square"></i> Chat</a>
          <a href="/freelancer/payments/" class="px-3 py-2 rounded-lg hover:bg-gray-50 flex items-center gap-2"><i class="lucide-credit-card"></i> Payments</a>
          <a href="/freelancer/reviews/" class="px-3 py-2 rounded-lg hover:bg-gray-50 flex items-center gap-2"><i class="lucide-star"></i> Reviews</a>
          <a href="/freelancer/analytics/" class="px-3 py-2 rounded-lg hover:bg-gray-50 flex items-center gap-2"><i class="lucide-bar-chart-2"></i> Analytics</a>
          <a href="/freelancer/verification/" class="px-3 py-2 rounded-lg bg-indigo-50 text-indigo-700 font-semibold flex items-center gap-2"><i class="lucide-shield-check"></i> Verification</a>
          <a href="/freelancer/support/" class="px-3 py-2 rounded-lg hover:bg-gray-50 flex items-center gap-2"><i class="lucide-life-buoy"></i> Support</a>
        </nav>
        <div class="border-t mt-4 pt-4">
          <div class="text-xs text-gray-500">Verification tier</div>
          <div class="mt-2 flex items-center gap-2">
            <span id="tierBadge" class="badge badge-gray">—</span>
            <span id="verifiedDot" class="dot" style="background:#CBD5E1"></span>
            <span id="verifiedText" class="text-xs text-gray-600">Not verified</span>
          </div>
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <section class="space-y-6 lg:space-y-8">
        <!-- Header -->
        <div class="card p-5 sm:p-6 hover-rise">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div class="min-w-0">
              <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">Identity Verification</h1>
              <p class="text-sm text-gray-600 mt-1">Upload your ID & a short selfie to get your verification badge and win more trust.</p>
              <div class="mt-2 flex flex-wrap gap-2 text-xs">
                <span id="statusBadge" class="badge badge-amber">Loading status…</span>
                <span class="badge badge-blue">Faster payouts</span>
                <span class="badge badge-green">Higher trust</span>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button id="refreshBtn" class="btn btn-soft"><i class="lucide-rotate-cw"></i>Refresh</button>
              <a href="/freelancer/support/" class="btn btn-ghost"><i class="lucide-help-circle"></i>Help</a>
            </div>
          </div>
        </div>

        <!-- 2-column: Document + Selfie -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
          <!-- Document Upload -->
          <div class="card p-5 sm:p-6 hover-rise">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-lg font-semibold">1) Upload Government ID</h2>
              <span class="tip">
                <i class="lucide-info text-gray-400"></i>
                <span class="tip-bubble">Supported: Passport / NID / Driver’s License</span>
              </span>
            </div>

            <div class="grid sm:grid-cols-[1fr_auto] gap-3">
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Document Type</label>
                <select id="docType" class="w-full border border-gray-300 rounded-md px-3 py-2">
                  <option value="passport">Passport</option>
                  <option value="nid">National ID</option>
                  <option value="license">Driver’s License</option>
                </select>
                <label class="text-sm font-medium text-gray-700 mt-3 block">Upload Document (JPG/PNG/PDF)</label>
                <input id="docFile" type="file" accept=".jpg,.jpeg,.png,.pdf" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white">
                <p class="text-xs text-gray-500 mt-1">Make sure details are clearly visible.</p>
              </div>
              <div class="flex sm:flex-col gap-2 mt-2 sm:mt-7">
                <button id="uploadDocBtn" class="btn btn-primary justify-center w-full sm:w-40"><i class="lucide-upload-cloud"></i>Upload</button>
                <button id="removeDocBtn" class="btn btn-ghost justify-center w-full sm:w-40 hidden"><i class="lucide-trash-2"></i>Remove</button>
              </div>
            </div>

            <!-- OCR Result -->
            <div id="ocrBox" class="mt-5 hidden">
              <div class="flex items-center justify-between mb-2">
                <div class="text-sm font-semibold">OCR Extraction</div>
                <span id="ocrConf" class="badge badge-gray">—</span>
              </div>
              <div id="ocrFields" class="grid sm:grid-cols-2 gap-3 text-sm"></div>
            </div>
          </div>

          <!-- Selfie Upload -->
          <div class="card p-5 sm:p-6 hover-rise">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-lg font-semibold">2) Selfie (Face Match)</h2>
              <span class="tip">
                <i class="lucide-info text-gray-400"></i>
                <span class="tip-bubble">Good lighting & frontal face recommended</span>
              </span>
            </div>

            <div class="grid sm:grid-cols-[1fr_auto] gap-3">
              <div>
                <label class="text-sm font-medium text-gray-700">Upload Selfie</label>
                <input id="selfieFile" type="file" accept="image/*" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-white">
                <p class="text-xs text-gray-500 mt-1">PNG/JPG only. Max 5MB.</p>
              </div>
              <div class="flex sm:flex-col gap-2 mt-2 sm:mt-7">
                <button id="uploadSelfieBtn" class="btn btn-primary justify-center w-full sm:w-40"><i class="lucide-camera"></i>Upload</button>
                <button id="removeSelfieBtn" class="btn btn-ghost justify-center w-full sm:w-40 hidden"><i class="lucide-trash-2"></i>Remove</button>
              </div>
            </div>

            <!-- Face match -->
            <div id="faceBox" class="mt-5 hidden">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold">Face Match</div>
                <span id="faceScore" class="badge badge-gray">—</span>
              </div>
              <p id="faceRemark" class="text-xs text-gray-600 mt-1">—</p>
            </div>
          </div>
        </div>

        <!-- Status & Timeline -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
          <!-- Live Status -->
          <div class="card p-5 sm:p-6 hover-rise">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-semibold">Live Status</h2>
              <span id="statusPill" class="badge badge-amber">Checking…</span>
            </div>
            <div class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-2">
              <div class="p-3 rounded-lg border text-center">
                <div class="text-xs text-gray-500">Profile</div>
                <div id="statusProfile" class="mt-1 font-semibold">—</div>
              </div>
              <div class="p-3 rounded-lg border text-center">
                <div class="text-xs text-gray-500">Document</div>
                <div id="statusDoc" class="mt-1 font-semibold">—</div>
              </div>
              <div class="p-3 rounded-lg border text-center">
                <div class="text-xs text-gray-500">Selfie</div>
                <div id="statusSelfie" class="mt-1 font-semibold">—</div>
              </div>
              <div class="p-3 rounded-lg border text-center">
                <div class="text-xs text-gray-500">Decision</div>
                <div id="statusDecision" class="mt-1 font-semibold">—</div>
              </div>
            </div>
            <div class="mt-4 text-xs text-gray-500">Last updated: <span id="lastSync">—</span></div>
          </div>

          <!-- History -->
          <div class="card p-5 sm:p-6 hover-rise xl:col-span-2">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-lg font-semibold">Review Timeline</h2>
              <button id="reloadHistoryBtn" class="btn btn-soft"><i class="lucide-history"></i>Reload</button>
            </div>
            <ul id="historyList" class="divide-y">
              <!-- skeleton -->
              <li class="py-4 flex items-start gap-3">
                <span class="dot" style="background:#CBD5E1"></span>
                <div class="w-full">
                  <div class="w-2/3 h-4 skeleton"></div>
                  <div class="w-1/3 h-3 skeleton mt-2"></div>
                </div>
              </li>
              <li class="py-4 flex items-start gap-3">
                <span class="dot" style="background:#CBD5E1"></span>
                <div class="w-full">
                  <div class="w-1/2 h-4 skeleton"></div>
                  <div class="w-1/4 h-3 skeleton mt-2"></div>
                </div>
              </li>
            </ul>
          </div>
        </div>

      </section>
    </div>
  </main>

  <!-- FOOTER (exactly as you provided) -->
  <footer id="contact" class="relative bg-gradient-to-b from-gray-50 to-white text-gray-800 border-t border-gray-200 mt-20"> 
    <div class="max-w-7xl mx-auto px-6 py-14 grid grid-cols-1 md:grid-cols-4 gap-10 text-sm">
      
      <!-- Brand Section -->
      <div>
        <div class="flex items-center space-x-2 mb-3">
          <img src="{% static 'images/logo.jpeg' %}" alt="JobsAlign Logo" class="w-32 h-auto object-contain">
        </div>
        <p class="text-gray-600 leading-relaxed">
          Empowering freelancers, clients, and businesses to collaborate, innovate, and succeed — all in one place.
        </p>
        <div class="flex space-x-4 mt-4">
          <a href="#" class="text-gray-500 hover:text-primary"><i class="fab fa-facebook-f"></i></a>
          <a href="#" class="text-gray-500 hover:text-primary"><i class="fab fa-twitter"></i></a>
          <a href="#" class="text-gray-500 hover:text-primary"><i class="fab fa-linkedin-in"></i></a>
          <a href="#" class="text-gray-500 hover:text-primary"><i class="fab fa-instagram"></i></a>
        </div>
      </div>

      <!-- Platform Links -->
      <div>
        <h4 class="text-lg font-semibold mb-3 text-secondary">Platform</h4>
        <ul class="space-y-2 text-gray-600">
          <li><a href="#marketplace" class="hover:text-primary">Marketplace</a></li>
          <li><a href="#jobs" class="hover:text-primary">Job Listings</a></li>
          <li><a href="#chats" class="hover:text-primary">Chats & Collaboration</a></li>
          <li><a href="#notifications" class="hover:text-primary">Notifications</a></li>
        </ul>
      </div>

      <!-- Resources -->
      <div>
        <h4 class="text-lg font-semibold mb-3 text-secondary">Resources</h4>
        <ul class="space-y-2 text-gray-600">
          <li><a href="#analytics" class="hover:text-primary">Analytics Dashboard</a></li>
          <li><a href="#support" class="hover:text-primary">Help & Support</a></li>
          <li><a href="#disputes" class="hover:text-primary">Dispute Center</a></li>
          <li><a href="#verification" class="hover:text-primary">Profile Verification</a></li>
        </ul>
      </div>

      <!-- About / Legal -->
      <div>
        <h4 class="text-lg font-semibold mb-3 text-secondary">About</h4>
        <ul class="space-y-2 text-gray-600">
          <li><a href="#about" class="hover:text-primary">About Us</a></li>
          <li><a href="#team" class="hover:text-primary">Our Team</a></li>
          <li><a href="#terms" class="hover:text-primary">Terms & Conditions</a></li>
          <li><a href="#privacy" class="hover:text-primary">Privacy Policy</a></li>
        </ul>
      </div>

    </div>

    <!-- Bottom Section -->
    <div class="border-t border-gray-200 mt-10 pt-6 pb-8 text-center text-gray-500 text-sm">
      <p>&copy; 2025 <span class="font-semibold text-primary">JobsAlign</span>. All rights reserved.</p>
      <p class="mt-2 text-blue-500">
        Developed by 
        <a href="https://somadhansoft.com/" class="hover:underline font-semibold text-blue-600" target="_blank" rel="noopener noreferrer">
          SomadhanSoft
        </a>
      </p>
    </div>
  </footer>

  <!-- INLINE JS -->
  <script>
    /********************
     * CONFIG & GUARDS  *
     ********************/
    const API_BASE = "http://127.0.0.1:8000/api";
    const API_ROUTES = {
      profile: "/accounts/profile/",
      verification: {
        status: "/verification/status/",
        upload_doc: "/verification/upload/",
        upload_selfie: "/verification/selfie/",
        history: "/verification/history/"
      },
      kyc_fallback: "/accounts/kyc/upload/"
    };

    const $ = (id)=>document.getElementById(id);
    const token = localStorage.getItem("access_token");
    if(!token){ window.location.href="/login/"; }

    function toast(msg,type="success"){
      const t=document.createElement("div");
      t.className="fixed z-[9999] bottom-6 right-6 px-4 py-3 rounded-lg text-sm text-white "+(type==="success"?"bg-emerald-600":"bg-rose-600");
      t.textContent=msg; document.body.appendChild(t);
      setTimeout(()=>t.remove(),2800);
    }
    async function apiGet(path){
      try{
        const r=await fetch(API_BASE+path,{headers:{Authorization:"Bearer "+token}});
        if(!r.ok) throw {status:r.status, text: await r.text()};
        return await r.json();
      }catch(e){ console.warn("GET",path,e); return {__error:true, ...e};}
    }
    async function apiPostJSON(path, body){
      try{
        const r=await fetch(API_BASE+path,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+token}, body:JSON.stringify(body)});
        if(!r.ok) throw {status:r.status, text: await r.text()};
        return await r.json();
      }catch(e){ console.warn("POST",path,e); return {__error:true, ...e};}
    }
    async function apiPostForm(path, formData){
      try{
        const r=await fetch(API_BASE+path,{method:"POST",headers:{Authorization:"Bearer "+token}, body:formData});
        if(!r.ok) throw {status:r.status, text: await r.text()};
        return await r.json();
      }catch(e){ console.warn("POST form",path,e); return {__error:true, ...e};}
    }
    const fmtTime = (iso)=> iso ? new Date(iso).toLocaleString() : "—";
    const setText=(id, val)=>{ const el=$(id); if(el) el.textContent = val; };
    const show=(id)=>$(id)?.classList?.remove("hidden");
    const hide=(id)=>$(id)?.classList?.add("hidden");

    /********************
     * PROFILE & STATUS *
     ********************/
    let PROFILE = null, STATUS = null, OCR_FIELDS=null;

    async function loadProfile(){
      const data = await apiGet(API_ROUTES.profile);
      if(data?.__error){ setText("statusProfile","—"); return; }
      PROFILE = data;
      setText("statusProfile", data?.email ? "OK" : "—");

      // sidebar tier + dot
      const verified = data?.is_verified || data?.is_identity_verified;
      const tier = data?.verification_tier || data?.level || "Basic";
      setText("tierBadge", tier);
      const dot = $("verifiedDot"); const label=$("verifiedText");
      if(verified){ dot.style.background = "#10B981"; label.textContent="Verified"; }
      else { dot.style.background = "#CBD5E1"; label.textContent="Not verified"; }
    }

    function applyStatusUI(){
      // Status object expected: { state: "pending|approved|rejected|in_review", doc:{ok, ocr_confidence, fields:{}}, selfie:{ok, score, remark}, decision:{by, at, note} }
      const st = STATUS || {};
      const state = (st.state || (PROFILE?.is_verified ? "approved" : "pending")).toLowerCase();

      const pill = $("statusPill");
      const badge = $("statusBadge");
      const last = $("lastSync");
      const docOK = st?.doc?.ok === true;
      const selfieOK = st?.selfie?.ok === true;

      // badges
      if(state==="approved"){ pill.className="badge badge-green"; pill.textContent="Approved"; badge.className="badge badge-green"; badge.textContent="Verified"; }
      else if(state==="rejected"){ pill.className="badge badge-amber"; pill.textContent="Changes required"; badge.className="badge badge-amber"; badge.textContent="Not Verified"; }
      else if(state==="in_review"){ pill.className="badge badge-blue"; pill.textContent="Under review"; badge.className="badge badge-blue"; badge.textContent="Submitted"; }
      else { pill.className="badge badge-amber"; pill.textContent="Pending"; badge.className="badge badge-amber"; badge.textContent="Pending"; }

      setText("statusDoc", docOK?"OK":"—");
      setText("statusSelfie", selfieOK?"OK":"—");
      setText("statusDecision", st?.decision?.at ? "Done" : "—");
      last.textContent = new Date().toLocaleTimeString();

      // OCR box
      if(st?.doc?.fields){
        OCR_FIELDS = st.doc.fields;
        const box = $("ocrBox"), fields = $("ocrFields"), conf=$("ocrConf");
        fields.innerHTML = Object.entries(st.doc.fields).slice(0,8).map(([k,v])=>`
          <div class="p-3 rounded-lg bg-gray-50 border">
            <div class="text-[11px] uppercase tracking-wide text-gray-500">${k}</div>
            <div class="text-sm font-semibold truncate">${v || "—"}</div>
          </div>
        `).join("");
        conf.textContent = "Confidence " + (Math.round((st.doc.ocr_confidence||0)*100)/100);
        box.classList.remove("hidden");
      }

      // Face box
      if(st?.selfie){
        const f = st.selfie;
        setText("faceScore", "Score " + (typeof f.score==="number" ? f.score.toFixed(2) : "—"));
        setText("faceRemark", f.remark || (f.ok ? "Match looks good" : "Please upload a clearer selfie"));
        $("faceBox").classList.remove("hidden");
      }
    }

    async function loadStatus(){
      // Try verification/status; on 404 fallback to profile flags
      const s = await apiGet(API_ROUTES.verification.status);
      if(s?.__error && s.status===404){
        STATUS = {
          state: (PROFILE?.is_verified || PROFILE?.is_identity_verified) ? "approved" : "pending",
          doc: { ok: !!PROFILE?.is_identity_verified },
          selfie: { ok: !!PROFILE?.is_verified }
        };
      }else if(!s?.__error){
        STATUS = s;
      }
      applyStatusUI();
    }

    /********************
     * HISTORY          *
     ********************/
    async function loadHistory(){
      const box = $("historyList");
      const res = await apiGet(API_ROUTES.verification.history);
      if(res?.__error){ 
        box.innerHTML = `<li class="py-5 text-sm text-gray-500">No history available.</li>`;
        return; 
      }
      const items = res?.results || res || [];
      if(!items.length){
        box.innerHTML = `<li class="py-5 text-sm text-gray-500">No history yet — submit your documents to begin.</li>`;
        return;
      }
      box.innerHTML = items.slice(0,12).map(it=>{
        const color = it.status==="approved"?"#10B981":it.status==="rejected"?"#EF4444":it.status==="in_review"?"#3B82F6":"#64748B";
        return `
          <li class="py-4 flex items-start gap-3">
            <span class="dot" style="background:${color}"></span>
            <div class="min-w-0">
              <div class="text-sm font-medium">${(it.title || "Verification") + " • " + (it.status || "—")}</div>
              <div class="text-xs text-gray-500 mt-0.5">${fmtTime(it.created_at)} — ${it.note || ""}</div>
            </div>
          </li>
        `;
      }).join("");
    }

    /********************
     * UPLOAD ACTIONS   *
     ********************/
    function disableBtn(btn, on=true){
      btn.disabled = on;
      btn.classList.toggle("opacity-60", on);
      btn.classList.toggle("cursor-not-allowed", on);
    }

    async function uploadDocument(){
      const file = $("docFile").files[0];
      const type = $("docType").value;
      const btn = $("uploadDocBtn");
      if(!file){ toast("Select a document first","error"); return; }
      disableBtn(btn, true);

      // Try primary endpoint
      const fd = new FormData();
      fd.append("document", file);
      fd.append("type", type);

      let res = await apiPostForm(API_ROUTES.verification.upload_doc, fd);

      // Fallback to accounts KYC if 404
      if(res?.__error && res.status===404){
        const fd2 = new FormData();
        fd2.append("identity_document", file);
        res = await apiPostForm(API_ROUTES.kyc_fallback, fd2);
      }

      disableBtn(btn, false);
      if(res?.__error){
        toast("Document upload failed","error");
        return;
      }
      toast("Document uploaded");
      show("removeDocBtn");
      await Promise.all([loadStatus(), loadHistory()]);
    }

    async function uploadSelfie(){
      const file = $("selfieFile").files[0];
      const btn = $("uploadSelfieBtn");
      if(!file){ toast("Select a selfie first","error"); return; }
      disableBtn(btn, true);

      const fd = new FormData();
      fd.append("selfie", file);

      let res = await apiPostForm(API_ROUTES.verification.upload_selfie, fd);

      // No fallback endpoint for selfie—if 404, show helpful hint
      if(res?.__error){
        if(res.status===404){
          toast("Selfie endpoint missing: add /api/verification/selfie/ on backend","error");
        }else{
          toast("Selfie upload failed","error");
        }
        disableBtn(btn,false);
        return;
      }

      disableBtn(btn,false);
      toast("Selfie uploaded");
      show("removeSelfieBtn");
      await loadStatus();
    }

    function clearDocSelection(){
      $("docFile").value = "";
      hide("removeDocBtn");
      toast("Document selection cleared");
    }
    function clearSelfieSelection(){
      $("selfieFile").value = "";
      hide("removeSelfieBtn");
      toast("Selfie selection cleared");
    }

    /********************
     * INIT + POLLING   *
     ********************/
    async function refreshAll(showToast=false){
      await loadProfile();
      await loadStatus();
      await loadHistory();
      if(showToast) toast("Refreshed");
    }

    // Bindings
    $("uploadDocBtn").onclick = uploadDocument;
    $("removeDocBtn").onclick = clearDocSelection;
    $("uploadSelfieBtn").onclick = uploadSelfie;
    $("removeSelfieBtn").onclick = clearSelfieSelection;
    $("reloadHistoryBtn").onclick = ()=>loadHistory();
    $("refreshBtn").onclick = ()=>refreshAll(true);

    // Initial
    refreshAll(false);

    // Background re-check every 70s (small load)
    setInterval(()=>loadStatus(), 70000);

    // Cross-tab profile sync (when profile updated from profile page)
    window.addEventListener("storage",(ev)=>{
      if(ev.key==="profile_updated" && ev.newValue==="1"){
        loadProfile(); setTimeout(()=>localStorage.removeItem("profile_updated"),200);
      }
    });
  </script>
</body>
</html>
